===============================================
DEPLOYING TO AWS EKS KUBERNETES CLUSTER
===============================================

PREREQUISITES
-------------
1. AWS CLI configured with proper credentials
2. kubectl installed and configured
3. Helm 3.x installed (available at D:\setup\dev\helm\windows-amd64\helm.exe)
4. Docker installed for building images
5. An existing EKS cluster
6. ECR repository for storing Docker images

STEP 1: SET UP IAM PERMISSIONS
--------------------------------
1. Create IAM policy for OpenTelemetry Collector:

   aws iam create-policy ^
     --policy-name OtelCollectorPolicy ^
     --policy-document file://aws-iam-policy.json

   Note: The aws-iam-policy.json file is already in the project root

2. Create IAM role with IRSA (IAM Roles for Service Accounts):

   eksctl create iamserviceaccount ^
     --name otel-collector-sa ^
     --namespace observability ^
     --cluster YOUR_CLUSTER_NAME ^
     --attach-policy-arn arn:aws:iam::YOUR_ACCOUNT_ID:policy/OtelCollectorPolicy ^
     --approve

3. Note the IAM role ARN that gets created - you'll need it later

STEP 2: BUILD AND PUSH DOCKER IMAGE
------------------------------------
1. Log in to Amazon ECR:

   aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin YOUR_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com

2. Create ECR repository (if not exists):

   aws ecr create-repository --repository-name otel-sample-app --region us-east-1

3. Build the Docker image:

   cd dotnet-sample\OtelSampleApp
   docker build -t otel-sample-app:latest .

4. Tag the image for ECR:

   docker tag otel-sample-app:latest YOUR_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/otel-sample-app:latest

5. Push to ECR:

   docker push YOUR_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/otel-sample-app:latest

STEP 3: UPDATE KUBERNETES MANIFESTS
------------------------------------
1. Update kubernetes/helm-values.yaml:
   - Replace YOUR_ACCOUNT_ID with your AWS account ID in the IAM role ARN
   - Line: eks.amazonaws.com/role-arn: "arn:aws:iam::YOUR_ACCOUNT_ID:role/otel-collector-role"

2. Update kubernetes/otel-collector-deployment.yaml:
   - Replace YOUR_ACCOUNT_ID with your AWS account ID in the ServiceAccount annotation

3. Update kubernetes/sample-app-deployment.yaml:
   - Replace "your-registry" with your ECR registry:
     YOUR_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/otel-sample-app:latest

STEP 4: DEPLOY OPENTELEMETRY COLLECTOR
---------------------------------------
Option A: Using Helm (Recommended)

1. Configure kubectl for your EKS cluster:

   aws eks update-kubeconfig --name YOUR_CLUSTER_NAME --region us-east-1

2. Run the deployment script:

   deploy-k8s.cmd YOUR_CLUSTER_NAME

   OR manually:

   D:\setup\dev\helm\windows-amd64\helm.exe repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
   D:\setup\dev\helm\windows-amd64\helm.exe repo update

   kubectl create namespace observability

   D:\setup\dev\helm\windows-amd64\helm.exe install opentelemetry-collector ^
     open-telemetry/opentelemetry-collector ^
     -f kubernetes/helm-values.yaml ^
     -n observability

Option B: Using kubectl manifests

1. Apply the manifests:

   kubectl apply -f kubernetes/otel-collector-deployment.yaml

STEP 5: DEPLOY SAMPLE APPLICATION
----------------------------------
1. Apply the sample app deployment:

   kubectl apply -f kubernetes/sample-app-deployment.yaml

2. Wait for the deployment to complete:

   kubectl rollout status deployment/otel-sample-app

STEP 6: VERIFY DEPLOYMENT
--------------------------
1. Check OpenTelemetry Collector status:

   kubectl get pods -n observability
   kubectl logs -n observability -l app=otel-collector

2. Check sample application status:

   kubectl get pods -l app=otel-sample-app
   kubectl get svc otel-sample-app

3. Get the LoadBalancer URL:

   kubectl get svc otel-sample-app -o jsonpath="{.status.loadBalancer.ingress[0].hostname}"

4. Test the application:

   curl http://LOAD_BALANCER_URL/health
   curl http://LOAD_BALANCER_URL/
   curl http://LOAD_BALANCER_URL/api/users/1

STEP 7: VIEW TELEMETRY IN AWS
------------------------------
1. AWS X-Ray Console:
   https://console.aws.amazon.com/xray/

2. CloudWatch Logs:
   https://console.aws.amazon.com/cloudwatch/
   - Log Groups: Look for logs from the collector and application

3. CloudWatch Metrics:
   - Navigate to CloudWatch Metrics
   - Select custom namespace: "OpenTelemetry/App"

TROUBLESHOOTING
---------------
1. Pods not starting:
   kubectl describe pod POD_NAME -n observability
   kubectl describe pod POD_NAME

2. Permission errors (X-Ray/CloudWatch):
   - Verify IAM role ARN is correct in ServiceAccount
   - Check OIDC provider is configured on EKS cluster:
     eksctl utils associate-iam-oidc-provider --cluster YOUR_CLUSTER_NAME --approve

3. Application can't reach collector:
   - Verify service name and namespace:
     kubectl get svc -n observability
   - Test connectivity from app pod:
     kubectl exec -it POD_NAME -- curl http://otel-collector.observability.svc.cluster.local:4317

4. Image pull errors:
   - Verify ECR repository permissions
   - Check if nodes have ECR access (usually automatic for EKS)

5. Check collector configuration:
   kubectl get configmap -n observability
   kubectl describe configmap otel-collector-config -n observability

SCALING
-------
1. Scale the collector:
   kubectl scale deployment otel-collector -n observability --replicas=3

2. Scale the sample app:
   kubectl scale deployment otel-sample-app --replicas=5

3. Enable autoscaling (HPA):
   kubectl autoscale deployment otel-sample-app --cpu-percent=70 --min=2 --max=10

CLEANUP
-------
1. Delete sample application:
   kubectl delete -f kubernetes/sample-app-deployment.yaml

2. Delete OpenTelemetry Collector (Helm):
   D:\setup\dev\helm\windows-amd64\helm.exe uninstall opentelemetry-collector -n observability

   OR (kubectl):
   kubectl delete -f kubernetes/otel-collector-deployment.yaml

3. Delete namespace:
   kubectl delete namespace observability

4. Delete IAM resources:
   eksctl delete iamserviceaccount --name otel-collector-sa --namespace observability --cluster YOUR_CLUSTER_NAME
   aws iam delete-policy --policy-arn arn:aws:iam::YOUR_ACCOUNT_ID:policy/OtelCollectorPolicy

5. Delete ECR repository:
   aws ecr delete-repository --repository-name otel-sample-app --force --region us-east-1

MONITORING BEST PRACTICES
--------------------------
1. Set up CloudWatch alarms for:
   - High error rates in X-Ray traces
   - Collector CPU/Memory usage
   - Application error rates

2. Use AWS CloudWatch Insights for log analysis:
   fields @timestamp, @message
   | filter @message like /error/
   | sort @timestamp desc
   | limit 20

3. Create X-Ray Service Map to visualize distributed traces

4. Set up CloudWatch dashboards for key metrics

COST OPTIMIZATION
-----------------
1. Use Fargate profiles for collector pods (optional)
2. Adjust collector batch sizes to reduce API calls
3. Use CloudWatch Logs retention policies
4. Sample traces if volume is high (configure in collector)
5. Use spot instances for non-production workloads

SECURITY CONSIDERATIONS
-----------------------
1. Use IRSA (IAM Roles for Service Accounts) - already configured
2. Enable encryption for CloudWatch Logs
3. Use VPC endpoints for AWS services to keep traffic private
4. Implement network policies to restrict pod-to-pod communication
5. Regularly update OpenTelemetry Collector image

ADDITIONAL RESOURCES
--------------------
- OpenTelemetry Documentation: https://opentelemetry.io/docs/
- AWS Distro for OpenTelemetry: https://aws-otel.github.io/
- EKS Best Practices: https://aws.github.io/aws-eks-best-practices/
- AWS X-Ray Documentation: https://docs.aws.amazon.com/xray/
